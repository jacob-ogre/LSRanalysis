---
title: "Analysis of _Lilaeopsis schaffneriana_ var. _recurva_ monitoring data"
author: "Aaron Cajero (FWS) and Jacob Malcom (DOW)"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 2
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(ggthemes)
library(lme4)
library(LSRanalysis)
library(MASS)
library(plotly)
library(tidyr)
data(LSR_monitor)

# Will convert the 2007 observers to arbitrary numbers
LSR_monitor$Observer <- ifelse(LSR_monitor$Observer == "JM",
                               1,
                               ifelse(LSR_monitor$Observer == "AP",
                                      2,
                                      ifelse(LSR_monitor$Observer == "BH",
                                             3,
                                             LSR_monitor$Observer)))
LSR_monitor$Observer <- as.numeric(LSR_monitor$Observer)
```

Since 2007, U.S. Fish and Wildlife Service personnel have monitored populations of _Lilaeopsis schaffneriana_ var. _recurva_ (LSR), a species listed as threatened under the U.S. Endangered Species Act (ESA), at San Bernardino and Leslie Canyon National Wildlife Refuges (SBLCNWR) in southeast Arizona. The species is a desert wetland obligate whose range has been substantially reduced by more than a century of land use that reduced the number, extent, and natural dynamics of wetlands in Arizona and Sonora, Mexico. LSR historically occurred on San Bernardino NWR but was apparently extirpated by the late 1990s, and plugs were transplanted in Leslie Canyon NWR in the 1990s, where the species still persists today. 

The LSR monitoring protocol requires that multiple people independently identify patches of the species at a given site, sketch the extent of those patches, and measure the patches (to the nearest 0.1m) and record the measurements on the sketches. After field work is complete, the sketches and their measurements are returned to the lab and computer software - either TurboCAD or ArcGIS - is used to draw representations of each patch to the scale dictated by the measurements. From these digital renderings the areal extent of LSR can be estimated for each site and as measured by each observer.

Here we analyze LSR monitoring data from the years `r unique(LSR_monitor$Year)` and across `r length(unique(LSR_monitor$Site))` sites at SBLCNWRs.

## First looks

As an initial overview of the LSR monitoring data, we will calculate the sum of the area estimated by each observer each year, then create a little plot.

```{r summary_1, fig.cap="The median area occupied by LSR varies substantially between years (heavy line of box-and-whiskers), but the inter-individual variation in estimated area appears minor in most years (but see 2011 and 2012)."}
by_yr <- aggregate(Area ~ Year + Observer, data = LSR_monitor, FUN = sum, na.rm =TRUE)
ggplot(data = by_yr, aes(x = factor(Year), y = Area)) +
  geom_boxplot(fill = "white") +
  geom_jitter(colour = "tan4", size = 4, alpha = 0.8, width = 0.3, height = 0.1) +
  labs(x = "Year",
       y = "Area (m^2)") +
  theme_hc()
```

Not sure what is going on with the 2011 and 2012 data...the other points most years are relatively tight, but in there's an obvious outlier for each of these two years. To start with, what are the medians?

```{r median_by_yr}
atab <- aggregate(Area ~ Year, 
                  data = by_yr, 
                  FUN = function(x) round(median(x), 2))
btab <- aggregate(Area ~ Year, 
                  data = by_yr, 
                  FUN = function(x) round(mean(x), 2))
ctab <- left_join(atab, btab, by = "Year")
names(ctab) <- c("Year", "Median Area", "Mean Area")
knitr::kable(ctab, align = "c")
```

We also should look at the distribution of patch sizes:

```{r patch_hist, message=FALSE}
qplot(LSR_monitor$Area, geom = "histogram") +
  labs(x = "Area (m^2)") +
  theme_hc()
```

As expected, the distribution is rather non-normal. Using a Generalized Linear Model with negative binomial errors may be appropriate, but will be complicated by the need for random effects for the `Observer`.

## Analysis

Accounting for variation in how different individuals find and measure patches is important. 

```{r analysis_1}
LSR_monitor$Obs_fac <- as.factor(LSR_monitor$Observer)
mod1 <- lm(Area ~ Year + Obs_fac + Site, data = LSR_monitor)
amod1 <- anova(mod1)

mod2 <- lm(Area ~ Year + Obs_fac, data = LSR_monitor)
amod2 <- anova(mod2)

mod3 <- lm(Area ~ Obs_fac, data = LSR_monitor)
amod3 <- anova(mod3)

tmp <- LSR_monitor
tmp$obs_resid <- resid(mod3)

mod4 <- lm(obs_resid ~ poly(Year, 4), data = tmp)
summary(mod4)
pred <- predict(mod4,
                data.frame(Year = seq(2007, 2016)), 
                interval = "confidence", 
                level = 0.95)

mod1 <- lmer(Area ~ (1|Year) + (1|Obs_fac), data = LSR_monitor)
mod1
```











